[[TOC]]

# 주가 예측 DNN 모델 설계

## 1. 개요
본 주가 예측은 **기본 시세 데이터**, **기술적 지표**, **외부 변수**를 종합적으로 활용하여 단기(1일~1주) 가격 변동을 예측하는 것이 목표이다.  
이를 위해 단순한 가격 데이터뿐만 아니라, 시장 심리와 거시경제 요소를 포함한 멀티소스 데이터를 통합 분석합니다.

**데이터 구성 요소**
1. **기본 시세 데이터**
   - 시가(Open), 고가(High), 저가(Low), 종가(Close) 또는 수정종가
   - 거래량(Volume)
   - 수급주체별 거래 정보: 개인, 기관, 외국인 순매수량(또는 순매수금액, 비중)
  
2. **기술적 지표**
   - 추세 지표: MA(5), MA(20), MA(60)
   - 변동성 지표: Bollinger Bands, ATR
   - 모멘텀 지표: RSI(14), Stochastic Oscillator
   - 추세/모멘텀 혼합: MACD, Signal, Histogram
   - 거래량 기반 지표: OBV, MFI

3. **외부 변수**
   - 코스피 지수
   - 원·달러 환율 (USD/KRW)
   - 반도체 업황 지표 (DRAM 현물가 등)
   - 글로벌 주요 지수 (NASDAQ, S&P500)
   - 금리(한국·미국), CPI, PPI
   - 뉴스 감성 점수

## 2. 모델 선정 방법

### 2.1 고려 요소
- **데이터 유형**: 시계열(OHLCV), 범주형(수급주체), 거시경제 지표 등 이질적 데이터 혼합 여부
- **예측 목표**: 가격(회귀) 또는 방향성(분류)
- **예측 기간**: 단기(1~7일) 또는 중기(1~3개월)
- **계산 효율성**: 실시간 예측 및 경량화 필요 여부
- **해석 가능성**: Feature Importance 제공 필요 여부

### 2.2 후보 모델 비교

#### 1) TFT (Temporal Fusion Transformer)
TFT는 Transformer 구조를 시계열 예측에 최적화한 모델로, 시계열 데이터뿐 아니라 범주형 데이터와 외부 변수를 동시에 처리할 수 있다.  
Attention 메커니즘을 활용하여 각 시점과 변수의 중요도를 산출할 수 있어, 예측뿐만 아니라 해석 가능성도 높다.  

- **장점**:  
  - 시계열, 범주형, 외부 변수 통합 처리 가능  
  - Feature Importance를 통해 모델 해석 가능  
  - 장·단기 패턴 동시 학습  
- **단점**:  
  - 구현 복잡도가 높음  
  - 데이터 전처리 과정이 복잡  
  - 연산량이 많아 학습 속도가 느릴 수 있음  
- **특징점**:  
  - 멀티소스 데이터가 필요한 환경에서 매우 강력하며, 금융·산업 분석에 해석력을 제공하는 최신 시계열 모델

#### 2) Seq2Seq LSTM + Attention
Seq2Seq LSTM은 Encoder-Decoder 구조를 기반으로 하며, Attention 메커니즘을 결합하여 입력 시계열의 특정 시점에 집중할 수 있게 한다.  
이를 통해 예측에 중요한 시점의 정보가 손실되지 않고 반영되며, 장기 의존성 문제를 완화한다.  

- **장점**:  
  - 장기 및 단기 패턴 모두 학습 가능  
  - 이벤트성 변동이나 특정 시점의 영향을 반영 가능  
- **단점**:  
  - 연산량이 많아 학습 시간이 길어질 수 있음  
  - 데이터가 충분하지 않으면 과적합 위험  
- **특징점**:  
  - 뉴스, 정책 변화 등 특정 이벤트가 시장에 미치는 영향을 분석하기에 적합


#### 3) 멀티인풋 LSTM (다중 입력 레이어)
멀티인풋 LSTM은 서로 다른 데이터군(예: 시세 데이터, 수급 데이터, 외부 변수)을 각기 다른 LSTM 또는 Dense Layer로 처리한 뒤 병합하여 학습하는 방식이다.  
이로 인해 데이터 특성별 맞춤 처리가 가능하다.  

- **장점**:  
  - 데이터군별 특성에 맞춰 독립적으로 처리 가능  
  - 구현 구조가 비교적 단순  
- **단점**:  
  - 해석력이 부족하여 변수 중요도 파악이 어려움  
  - 입력 변수 간 상호작용을 모델이 자동으로 포착하기 어려울 수 있음  
- **특징점**:  
  - 서로 다른 성격의 데이터가 많은 경우 유연하게 모델 구조를 설계할 수 있음


#### 4) GRU (Gated Recurrent Unit)
GRU는 LSTM과 유사한 RNN 구조이지만, 파라미터 수가 적고 계산 효율성이 높은 모델이다.  
구조가 단순해 빠른 학습 속도를 제공하며, 자원이 제한된 환경에서도 안정적인 성능을 발휘한다.  

- **장점**:  
  - LSTM보다 학습 속도가 빠르고 메모리 사용량이 적음  
  - 적은 데이터에서도 비교적 안정적 성능  
- **단점**:  
  - 장기 의존성 처리 성능은 LSTM보다 약간 떨어질 수 있음  
- **특징점**:  
  - 실시간 예측이나 연산 자원이 제한된 상황에서 유리하며, 간단한 구조 대비 우수한 성능을 제공

### 2.3 모델 선정

#### 1) 외부 변수 적용 시
**추천 모델**: **TFT (Temporal Fusion Transformer)**  
- **추천 이유**:  
  외부 변수(거시경제 지표, 글로벌 지수, 산업 지표, 뉴스 감성 등)를 함께 사용하는 경우, 각 변수의 시간적 영향력과 중요도를 동시에 파악할 수 있는 모델이 필요하다.  
  TFT는 시계열 데이터뿐 아니라 범주형 데이터와 정적·동적 외부 변수를 함께 처리할 수 있으며, Attention 메커니즘을 통해 각 변수와 시점의 기여도를 해석할 수 있다.  
  이는 복잡한 상관관계를 가진 멀티소스 데이터를 통합 분석하는 데 특히 강점이 있다.

#### 2) 외부 변수 미적용 시
**추천 모델**: **멀티인풋 LSTM 또는 Seq2Seq LSTM + Attention**  
- **멀티인풋 LSTM 추천 이유**:  
  외부 변수 없이도 시세 데이터와 수급 데이터, 기술적 지표처럼 성격이 다른 데이터군을 분리 처리하여 결합할 수 있어, 데이터 특성별 최적 학습이 가능하다.  
  구조가 비교적 단순하여 구현이 용이하며, 시계열 기반의 금융 데이터 예측에서 안정적 성능을 제공한다.
- **Seq2Seq LSTM + Attention 추천 이유**:  
  시세 데이터 내 특정 시점(예: 급등락 발생일)의 패턴이 미래 예측에 중요한 경우, Attention을 통해 해당 시점의 가중치를 높여 반영할 수 있다.  
  장·단기 패턴을 동시에 학습할 수 있어, 변동성이 높은 시장에서도 유리하다.

## 3. 데이터 파이프라인 설계
  ### 3.1 전체 흐름 
데이터 수집 → 데이터 전처리 → 특징(Feature) 생성 → 학습 데이터셋 구성 → 모델 학습 → 예측 및 평가

#### 1) 데이터 수집
- **목표**: 시세(OHLCV), 수급주체, 기술지표 원천 데이터, 외부 변수를 기간·빈도에 맞춰 확보하는 단계
- **주요 작업**: 소스 정의(Yahoo/증권사·KRX API/거시·산업·뉴스), 티커 및 기간 지정, 거래일 기준 정렬, 열 이름 표준화
- **유의점**: 한국장(Asia/Seoul) 기준 시간대 정합성 확보, 월·주간 지표의 일간 변환 필요, 중복·누락 레코드 확인
- **산출물**: 원본 레이어(raw/bronze) 파일(CSV/Parquet)

#### 2) 데이터 전처리
- **목표**: 학습 가능 상태로 품질 정제
- **주요 작업**: 결측치 보간(FFill/선형), 비정상값 처리(z-score/IQR, 윈저라이즈), 수정주가 적용, 휴장일 캘린더 정합화
- **스케일링**: 지표군별 스케일 분리(가격·거래량, 수급주체, 외부 변수), **스케일러는 학습 세트로만 적합 후 저장**
- **산출물**: 정제 레이어(clean/silver) 데이터셋, 스케일러 아티팩트

#### 3) 특징(Feature) 생성
- **목표**: 예측력을 갖춘 파생 변수 생성
- **기술지표**: MA(5/20/60), Bollinger, ATR, RSI, Stoch, MACD/Signal/Hist, OBV, MFI 등
- **수급주체**: 순매수량·금액·비중, 롤링 합·평균(예: 3/5/10일), **t시점 예측에는 t까지의 정보만 사용(누수 방지)**
- **외부 변수**: 환율·지수 수익률 및 변화율(Δ, %chg), 변동성 롤링, 월간 지표의 일간 Forward-fill, 미국 지수는 전일 종가를 당일 한국장에 매핑
- **캘린더**: 요일/월말/파생만기 등 이벤트 더미
- **산출물**: 피처 레이어(feature/gold) 테이블

#### 4) 학습 데이터셋 구성
- **목표**: 모델 입력 텐서와 타깃 정의
- **윈도우**: lookback **L**일, 예측 지평 **H**일 설정  
  - 회귀 타깃 예시: `r_{t+H} = log(C_{t+H}/C_t)` 또는 `C_{t+H}`
  - 분류 타깃 예시: `sign(r_{t+H})`
- **입력 형태**: `[배치, L, 특성수]` (예: `[32, 30, 25]`)
- **데이터 분할**: 시계열 순서 유지 Train/Val/Test, **워크포워드 검증** 권장
- **산출물**: 학습/검증/테스트 텐서, 타깃 벡터, 메타(인덱스·날짜)

#### 5) 모델 학습
- **모델 선택**: 외부 변수 포함 시 **TFT** 우선, 미포함 시 **멀티인풋 LSTM/Seq2Seq+Attention**
- **학습 설정**: 손실(MSE/MAE 또는 BCE), 옵티마이저(Adam/AdamW), 조기종료, 러닝레이트 스케줄, 시드 고정
- **로깅**: 학습·검증 지표, 체크포인트 저장, 피처 중요도(TFT) 산출
- **산출물**: 최적 가중치, 학습 로그, 설정 파일(config), 피처 중요도

#### 6) 예측 및 평가
- **회귀 지표**: RMSE, MAE, MAPE
- **방향 지표**: Hit Ratio, Precision/Recall/F1(분류 시)
- **운용 관점**: 단순 전략 백테스트(거래비용 반영), 누적 수익률·샤프 비율, 드로다운
- **오류 분석**: 변동성 구간·뉴스 이벤트별 성능, 피처 중요도 해석, 잔차 패턴 점검
- **모니터링/재학습**: 데이터·성능 드리프트 감지, 주기적 재학습 스케줄
- **산출물**: 예측 결과, 평가 리포트/그래프, 배포 아티팩트(모델+스케일러+컨피그)


